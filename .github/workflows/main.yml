name: Auto build blog
on:
  push:
    branches:
      - master
  repository_dispatch:
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
    - name: Set up Node.js
      uses: actions/setup-node@main
      with:
        node-version: '10.x'
    - name: Check out code
      uses: actions/checkout@main
    - name: Fetch posts
      run: |
        git clone https://${{secrets.UPLOAD_TOKEN}}@github.com/gyj1109/Blog-Posts.git source/_posts
        rm -rf source/_posts/.git*
    - name: Install npm packages
      run: |
        npm install -g hexo-cli
        npm install
        npm update
    - name: Apply custom patches
      run: |
        cp plugins/hexo-generator-search/search.xml node_modules/hexo-generator-search/templates/search.xml
        cp plugins/hexo-prism-plugin/index.js node_modules/hexo-prism-plugin/src/index.js
    - name: Build
      run: |
        hexo g
    - name: Config git
      run: |
        git config --global user.name "Actions"
        git config --global user.email "actions@github.com"
    - name: Push to Github
      run: |
        cd ./public
        git init
        git add .
        git commit -m "GitHub Pages"
        git push --force "https://${{secrets.UPLOAD_TOKEN}}@github.com/gyj1109/Blog.git" master:gh-pages
